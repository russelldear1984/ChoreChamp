{% extends "base.html" %}

{% block title %}Parent Dashboard - Chore Champions{% endblock %}

{% block content %}
<div class="min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800">👨‍👩‍👧‍👦 Parent Dashboard</h1>
                    <p class="text-gray-600 mt-2">Manage tasks, track progress, and configure rewards</p>
                </div>
                <div class="flex space-x-4">
                    <button 
                        onclick="closeWeek()"
                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold"
                        id="closeWeekBtn"
                    >
                        📊 Close Week
                    </button>
                    <a href="/parent/logout" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold">
                        🚪 Logout
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Children Overview -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div id="childrenOverview" class="bg-white rounded-3xl shadow-2xl p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">📊 This Week's Progress</h2>
                <div id="childrenStats" class="space-y-4">
                    <div class="text-center py-4">
                        <div class="animate-spin text-2xl mb-2">⏳</div>
                        <p class="text-gray-600">Loading children stats...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-3xl shadow-2xl p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">⚙️ Quick Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Full Payout Amount (£)</label>
                        <input 
                            type="number" 
                            id="fullPayoutAmount"
                            step="0.01"
                            min="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            placeholder="3.00"
                        >
                    </div>
                    <button 
                        onclick="updateSettings()"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold"
                    >
                        Update Settings
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tasks Management -->
        <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">📋 Task Catalogue</h2>
                <button 
                    onclick="showAddTaskModal()"
                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold"
                >
                    ➕ Add Task
                </button>
            </div>
            
            <div id="tasksList" class="space-y-4">
                <div class="text-center py-8">
                    <div class="animate-spin text-4xl mb-4">⏳</div>
                    <p class="text-gray-600">Loading tasks...</p>
                </div>
            </div>
        </div>
        
        <!-- Weekly Summary -->
        <div class="bg-white rounded-3xl shadow-2xl p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">📈 Weekly Summary</h2>
            <div id="weeklySummary" class="text-center py-8">
                <p class="text-gray-600">Close the week to see summary and payouts</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-gray-800 mb-6">Add New Task</h3>
        
        <form onsubmit="addTask(event)" class="space-y-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Task Name</label>
                <input 
                    type="text" 
                    id="taskName"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    required
                >
            </div>
            
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                <textarea 
                    id="taskDescription"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    rows="3"
                ></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">XP Points</label>
                <input 
                    type="number" 
                    id="taskPoints"
                    min="1"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    required
                >
            </div>
            
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                <select 
                    id="taskCategory"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                >
                    <option value="DAILY">Daily</option>
                    <option value="BEHAVIOUR">Behaviour</option>
                    <option value="WEEKLY">Weekly</option>
                </select>
            </div>
            
            <div class="flex items-center space-x-4">
                <label class="flex items-center">
                    <input type="checkbox" id="taskRequired" class="mr-2">
                    <span class="text-sm font-semibold text-gray-700">Required</span>
                </label>
                
                <label class="flex items-center">
                    <input type="checkbox" id="taskStreakable" class="mr-2">
                    <span class="text-sm font-semibold text-gray-700">Streakable</span>
                </label>
            </div>
            
            <div class="flex space-x-4 pt-4">
                <button 
                    type="button"
                    onclick="hideAddTaskModal()"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold"
                >
                    Cancel
                </button>
                <button 
                    type="submit"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-semibold"
                >
                    Add Task
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        loadChildrenStats();
        loadTasks();
        loadSettings();
    });
    
    async function loadChildrenStats() {
        try {
            const response = await fetch('/api/children');
            const children = await response.json();
            
            const container = document.getElementById('childrenStats');
            container.innerHTML = children.map(child => `
                <div class="bg-${child.color}-50 border border-${child.color}-200 rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">${child.avatar}</span>
                            <div>
                                <h4 class="text-lg font-bold text-${child.color}-700">${child.name}</h4>
                                <p class="text-sm text-gray-600">Level ${child.level} • ${child.xp} XP</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-${child.color}-600">${child.weekly_points}</div>
                            <div class="text-sm text-gray-600">Weekly Points</div>
                            <div class="flex items-center mt-1">
                                <span class="text-sm">🔥</span>
                                <span class="text-sm font-bold text-orange-500 ml-1">${child.streak_count}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading children stats:', error);
            showError('Failed to load children stats');
        }
    }
    
    async function loadTasks() {
        try {
            const response = await fetch('/api/tasks');
            const tasks = await response.json();
            
            const container = document.getElementById('tasksList');
            container.innerHTML = tasks.map(task => `
                <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold text-gray-800">${task.name}</h4>
                            <p class="text-gray-600 mt-1">${task.description || 'No description'}</p>
                            <div class="flex items-center mt-2 space-x-2">
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">${task.points} XP</span>
                                <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm">${task.category}</span>
                                ${task.is_required ? '<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm">Required</span>' : ''}
                                ${task.streakable ? '<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">Streakable</span>' : ''}
                            </div>
                        </div>
                        <div class="ml-4">
                            <button 
                                onclick="deleteTask(${task.id})"
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading tasks:', error);
            showError('Failed to load tasks');
        }
    }
    
    async function loadSettings() {
        try {
            const response = await fetch('/api/settings');
            const settings = await response.json();
            
            document.getElementById('fullPayoutAmount').value = settings.full_payout_amount;
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }
    
    async function closeWeek() {
        const button = document.getElementById('closeWeekBtn');
        button.disabled = true;
        button.textContent = 'Closing...';
        button.classList.add('animate-pulse');
        
        try {
            const response = await fetch('/api/weeks/close', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('Week closed successfully!');
                
                // Show summary
                const summaryContainer = document.getElementById('weeklySummary');
                summaryContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Week Closed - Payouts Calculated</h3>
                    ${result.results.map(child => `
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                            <h4 class="text-lg font-bold text-green-700">${child.child_name}</h4>
                            <p class="text-gray-600">${child.total_points} points earned</p>
                            <p class="text-xl font-bold text-green-600">Payout: £${child.payout.toFixed(2)}</p>
                            <p class="text-sm ${child.all_required_completed ? 'text-green-600' : 'text-yellow-600'}">
                                ${child.all_required_completed ? '✅ All required tasks completed' : '⚠️ Some required tasks missed'}
                            </p>
                        </div>
                    `).join('')}
                `;
                
                loadChildrenStats(); // Refresh stats
            } else {
                showError(result.error || 'Failed to close week');
            }
        } catch (error) {
            console.error('Error closing week:', error);
            showError('Failed to close week');
        } finally {
            button.disabled = false;
            button.textContent = '📊 Close Week';
            button.classList.remove('animate-pulse');
        }
    }
    
    function showAddTaskModal() {
        document.getElementById('addTaskModal').classList.remove('hidden');
    }
    
    function hideAddTaskModal() {
        document.getElementById('addTaskModal').classList.add('hidden');
        // Reset form
        document.querySelector('#addTaskModal form').reset();
    }
    
    async function addTask(event) {
        event.preventDefault();
        
        const taskData = {
            name: document.getElementById('taskName').value,
            description: document.getElementById('taskDescription').value,
            points: parseInt(document.getElementById('taskPoints').value),
            category: document.getElementById('taskCategory').value,
            is_required: document.getElementById('taskRequired').checked,
            streakable: document.getElementById('taskStreakable').checked,
            active_days: [0, 1, 2, 3, 4, 5, 6] // All days for now
        };
        
        try {
            const response = await fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(taskData)
            });
            
            if (response.ok) {
                showSuccess('Task added successfully!');
                hideAddTaskModal();
                loadTasks(); // Refresh tasks list
            } else {
                const error = await response.json();
                showError(error.error || 'Failed to add task');
            }
        } catch (error) {
            console.error('Error adding task:', error);
            showError('Failed to add task');
        }
    }
    
    async function deleteTask(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showSuccess('Task deleted successfully!');
                loadTasks(); // Refresh tasks list
            } else {
                const error = await response.json();
                showError(error.error || 'Failed to delete task');
            }
        } catch (error) {
            console.error('Error deleting task:', error);
            showError('Failed to delete task');
        }
    }
    
    async function updateSettings() {
        const fullPayoutAmount = document.getElementById('fullPayoutAmount').value;
        
        if (!fullPayoutAmount || parseFloat(fullPayoutAmount) < 0) {
            showError('Please enter a valid payout amount');
            return;
        }
        
        try {
            const response = await fetch('/api/settings', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    full_payout_amount: parseFloat(fullPayoutAmount)
                })
            });
            
            if (response.ok) {
                showSuccess('Settings updated successfully!');
            } else {
                const error = await response.json();
                showError(error.error || 'Failed to update settings');
            }
        } catch (error) {
            console.error('Error updating settings:', error);
            showError('Failed to update settings');
        }
    }
</script>
{% endblock %}